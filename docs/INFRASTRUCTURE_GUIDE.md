# Infrastructure Provisioning Guide

Complete guide for provisioning AWS infrastructure for the Docker Swarm cluster using Terraform and Ansible.

## Overview

The infrastructure consists of:
- **VPC**: Isolated network with public subnets across 2 AZs (cost-optimized, no NAT gateway)
- **EC2 Instances**: 1 manager + 2 workers (t3.medium, Ubuntu 22.04 LTS)
- **Security Groups**: Swarm communication, HTTP/HTTPS, monitoring ports
- **Auto-Generated SSH Keys**: TLS provider generates .pem keys automatically

## Prerequisites

### Required GitHub Secrets

Configure these in your GitHub repository (Settings â†’ Secrets and variables â†’ Actions):

**AWS Credentials:**
- `AWS_ACCESS_KEY_ID` - AWS access key
- `AWS_SECRET_ACCESS_KEY` - AWS secret key
- `AWS_REGION` - AWS region (e.g., us-east-1)

**Application Secrets:**
- `MYSQL_ROOT_PASSWORD` - MySQL root password
- `MYSQL_PASSWORD` - WordPress database password
- `SLACK_WEBHOOK_URL` - Slack webhook for AlertManager (optional)

**Note:** SSH keys are automatically generated by Terraform using the TLS provider. No need to provide your own!

## Automated Provisioning (GitHub Actions)

### Two-Stage CI/CD Pipeline

The repository uses a fully automated two-stage pipeline:

**Stage 1: PR to `dev` â†’ Infrastructure Provisioning**
- Validates Terraform and Ansible code
- Provisions AWS infrastructure
- Configures Docker Swarm cluster
- Comments PR with manager IP and SSH instructions
- Infrastructure remains active until PR closes

**Stage 2: Merge to `main` â†’ Stack Deployment**
- Validates stack configurations
- Deploys monitoring stack (Prometheus, Grafana, AlertManager)
- Deploys WordPress application
- Runs health checks and rollback on failure

**Stage 3: PR Close â†’ Automatic Cleanup**
- Destroys all AWS resources
- Stops infrastructure costs
- Preserves Terraform state for audit

### Workflow: PR to Dev (Infrastructure)

**File:** `.github/workflows/pr-dev-provision.yml`

**Trigger:** Pull request to `dev` branch

**Process:**
```bash
git checkout -b feature/my-feature
# Make changes
git push origin feature/my-feature
# Create PR: feature/my-feature â†’ dev
# âœ… Infrastructure automatically provisioned (10-15 min)
```

**Workflow stages:**
1. **Validate** - Terraform format, Ansible syntax, pytest tests
2. **Provision** - Terraform apply, generate .pem key
3. **Configure** - Ansible playbook, Swarm initialization
4. **Comment PR** - Manager IP, SSH instructions, next steps

### Workflow: Main Deploy (Stacks)

**File:** `.github/workflows/main-deploy-stacks.yml`

**Trigger:** Merge to `main` branch

**Process:**
```bash
# After PR approved
# Merge PR: dev â†’ main
# âœ… Stacks automatically deployed (5-8 min)
```

**Workflow stages:**
1. **Preflight** - Check infrastructure exists
2. **Validate** - YAML syntax, secrets verification
3. **Deploy Monitoring** - Prometheus, Grafana, AlertManager
4. **Deploy Application** - MySQL, WordPress (3 replicas)
5. **Health Check** - Verify services, rollback on failure

### Workflow: Cleanup (Teardown)

**File:** `.github/workflows/pr-dev-cleanup.yml`

**Trigger:** PR to `dev` closed

**Process:**
```bash
# Close or merge PR to dev
# âœ… Infrastructure automatically destroyed (3-5 min)
```

**Workflow stages:**
1. **Confirm** - Auto-confirm on PR close
2. **Destroy** - Terraform destroy all resources
3. **Comment PR** - Cleanup confirmation

## Manual Provisioning

For manual deployment without GitHub Actions, use the one-command deployment script.

### Step 1: Set Environment Variables

```bash
export AWS_REGION="us-east-1"
export MYSQL_ROOT_PASSWORD="your_secure_password"
export MYSQL_PASSWORD="your_app_password"
export SLACK_WEBHOOK_URL="https://hooks.slack.com/..." # optional
```

### Step 2: Run Validation

```bash
./validate.sh
```

### Step 3: Deploy Everything

```bash
./deploy.sh
```

The script automatically:
1. Sets up Terraform backend (S3 + DynamoDB)
2. Provisions AWS infrastructure
3. Generates .pem SSH key (`swarm-key.pem`)
4. Configures Swarm cluster with Ansible
5. Deploys monitoring and application stacks

### Step 4: Access Services

SSH key is auto-saved to `swarm-key.pem`:

```bash
# Get manager IP
cd infra/terraform
MANAGER_IP=$(terraform output -raw swarm_manager_public_ip)

# SSH to manager
ssh -i ../../swarm-key.pem ubuntu@${MANAGER_IP}

# Verify cluster
docker node ls
```

### Alternative: Step-by-Step Manual

If you prefer granular control:

```bash
# 1. Setup Terraform backend
cd infra/terraform
./setup-backend.sh
terraform init

# 2. Provision infrastructure
terraform plan
terraform apply

# 3. Save SSH key
terraform output -raw private_key_pem > ../../swarm-key.pem
chmod 600 ../../swarm-key.pem

# 4. Generate Ansible inventory
terraform output -raw ansible_inventory > ../ansible/inventory/hosts.ini

# 5. Configure Swarm with Ansible
cd ../ansible
ansible-playbook -i inventory/hosts.ini playbooks/site.yml --private-key=../../swarm-key.pem -v

# 6. Deploy stacks
MANAGER_IP=$(cd ../terraform && terraform output -raw swarm_manager_public_ip)
ssh -i ../../swarm-key.pem ubuntu@${MANAGER_IP}
cd ~/stack-monitoring
docker stack deploy -c monitoring-stack.yml monitoring
cd ~/stack-app
docker stack deploy -c docker-stack.yml levelop-wp
```

## Security Hardening

The Ansible `security-hardening` role applies:
- **SSH**: Disable password auth, disable root login, key-only access
- **Firewall (UFW)**: Allow SSH (22), Swarm ports (2377, 7946, 4789), HTTP/HTTPS (80, 443), monitoring (9090, 3000, 9093)

## Cost Estimation

**Monthly AWS costs (us-east-1):**
- 3 Ã— t3.medium instances: ~$100
- EBS volumes (3 Ã— 30GB): ~$9
- Data transfer: Variable
- **Total: ~$110/month**

**Cost Savings vs Traditional Architecture:**
- No NAT Gateway: **Save ~$32/month** (~29% reduction)
- All nodes in public subnets with direct internet access
- Simplified networking architecture

## Troubleshooting

### Terraform Errors

**Invalid AWS credentials:**
```
Solution: Verify AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets
```

### Ansible Errors

**SSH connection failed:**
```
Solution:
1. Verify SSH_PRIVATE_KEY matches SSH_PUBLIC_KEY
2. Check security group allows SSH from GitHub Actions IPs
3. Wait 60s for instances to boot
```

## Infrastructure Cleanup

### Automatic Cleanup (CI/CD)

Infrastructure is automatically destroyed when you close the PR to `dev`:

```bash
# Close or merge PR to dev branch
# âœ… Infrastructure automatically destroyed within 3-5 minutes
# ðŸ’° AWS costs stop immediately
```

**Workflow:** `.github/workflows/pr-dev-cleanup.yml`

**Benefits:**
- No manual intervention required
- Prevents lingering infrastructure costs
- Terraform state preserved in S3 for audit
- PR comment confirms successful cleanup

### Manual Cleanup

**Option 1: Use the deployment script**

```bash
./destroy.sh
```

**Option 2: Manual Terraform destroy**

```bash
cd infra/terraform

# Review what will be destroyed
terraform plan -destroy

# Destroy infrastructure
terraform destroy

# Confirm by typing: yes
```

**Option 3: GitHub Actions manual trigger**

1. Navigate to: **GitHub â†’ Actions â†’ PR to Dev - Cleanup â†’ Run workflow**
2. Enter confirmation: Type `DESTROY`
3. Click "Run workflow"

### What Gets Destroyed

When cleanup runs, ALL of the following are permanently deleted:
- VPC and all networking (subnets, IGW, route tables)
- All EC2 instances (manager + workers)
- All security groups
- Auto-generated SSH key pairs
- **All data on instances** (WordPress data, MySQL data, monitoring data)

**Note:** Terraform state is preserved in S3 backend for audit purposes.

### Post-Cleanup Verification

After destroying infrastructure:
1. Verify in AWS Console all resources are gone
2. Check for orphaned resources:
   - EBS snapshots
   - Elastic IPs (should be none with public subnet architecture)
3. Verify Terraform state in S3 (if needed for compliance)

### Cost Impact

Destroying infrastructure stops all AWS charges:
- **Active Infrastructure**: ~$110/month
- **After Cleanup**: $0/month (no orphaned resources)

## Next Steps

After infrastructure is provisioned:

1. **Get Manager IP** from PR comment or Terraform output
2. **Merge to Main** to deploy stacks:
   ```bash
   # Merge dev â†’ main to trigger stack deployment
   ```
3. **Access Services:**
   - WordPress: `http://<manager_ip>`
   - Grafana: `http://<manager_ip>:3000` (admin/admin)
   - Prometheus: `http://<manager_ip>:9090`
   - AlertManager: `http://<manager_ip>:9093`

4. **SSH Access:**
   ```bash
   # Download swarm-key.pem from workflow artifacts
   ssh -i swarm-key.pem ubuntu@<manager_ip>
   ```

5. **Close PR** when done to automatically destroy infrastructure and stop costs

See [CI/CD Workflow Guide](CI_CD_WORKFLOW.md) for detailed pipeline documentation.
