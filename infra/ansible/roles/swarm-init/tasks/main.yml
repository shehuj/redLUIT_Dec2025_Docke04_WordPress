---
# Check Swarm status
- name: Check if Swarm is already initialized
  ansible.builtin.shell: docker info --format '{{"{{"}}.Swarm.LocalNodeState{{"}}"}}'
  register: swarm_status
  changed_when: false
  failed_when: false

# Leave swarm if in an error state (force)
- name: Leave swarm if in error state
  ansible.builtin.command: docker swarm leave --force
  when: swarm_status.stdout == 'error'

# Re-check status after leave if needed
- name: Re-check Swarm status after force leave
  ansible.builtin.shell: docker info --format '{{"{{"}}.Swarm.LocalNodeState{{"}}"}}'
  register: swarm_status
  changed_when: false
  failed_when: false
  when: swarm_status.stdout == 'error'

# Initialize Swarm on the first manager if not active
- name: Initialize Docker Swarm on manager
  ansible.builtin.command: >
    docker swarm init
    --advertise-addr {{ ansible_default_ipv4.address }}
  when:
    - inventory_hostname in groups['swarm_managers']
    - swarm_status.stdout != 'active'
  register: swarm_init
  changed_when: "'Swarm initialized' in swarm_init.stdout"

# Get worker join token (from first manager only)
- name: Get worker join token
  ansible.builtin.command: docker swarm join-token -q worker
  register: worker_token
  when: inventory_hostname == groups['swarm_managers'][0]
  changed_when: false
  run_once: true

# Join workers if not already active
- name: Join worker to Swarm
  ansible.builtin.command: >
    docker swarm join
    --token {{ worker_token.stdout }}
    {{ hostvars[groups['swarm_managers'][0]]['ansible_default_ipv4']['address'] }}:2377
  when:
    - inventory_hostname in groups['swarm_workers']
    - swarm_status.stdout != 'active'
  register: join_result
  failed_when: false
  changed_when: "'This node joined a swarm' in join_result.stdout"

# Wait for workers to settle
- name: Wait for workers to join
  ansible.builtin.pause:
    seconds: 15
  when: inventory_hostname in groups['swarm_workers']

# Verify worker status is active
- name: Verify worker joined successfully
  ansible.builtin.shell: docker info --format '{{"{{"}}.Swarm.LocalNodeState{{"}}"}}'
  register: final_status
  until: final_status.stdout == 'active'
  retries: 6
  delay: 10
  when: inventory_hostname in groups['swarm_workers']
  changed_when: false

# Show status message on fail
- name: Debug worker join failure
  ansible.builtin.debug:
    msg: |
      Worker status: {{ final_status.stdout }}
      If not 'active', ensure:
        - Manager reachable on port 2377
        - Security groups / firewall rules allow communication
        - Join token correct
  when:
    - inventory_hostname in groups['swarm_workers']
    - final_status.stdout != 'active'
  failed_when: final_status.stdout != 'active'

# Show nodes on manager
- name: Verify Swarm cluster nodes
  ansible.builtin.command: docker node ls
  register: node_list
  when: inventory_hostname in groups['swarm_managers']
  changed_when: false
  retries: 3
  delay: 8
  until: node_list.rc == 0

- name: Display Swarm cluster nodes
  ansible.builtin.debug:
    msg: "{{ node_list.stdout_lines }}"
  when:
    - inventory_hostname in groups['swarm_managers']
    - node_list is defined