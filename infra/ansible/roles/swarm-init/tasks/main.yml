---
# Docker Swarm initialization

- name: Check if Swarm is already initialized
  shell: docker info --format '{{"{{"}}.Swarm.LocalNodeState{{"}}"}}'
  register: swarm_status
  changed_when: false
  failed_when: false

- name: Initialize Docker Swarm on manager
  command: >
    docker swarm init
    --advertise-addr {{ ansible_default_ipv4.address }}
  when:
    - inventory_hostname in groups['swarm_managers']
    - swarm_status.stdout != 'active'
  register: swarm_init_result

- name: Get worker join token
  command: docker swarm join-token -q worker
  register: worker_token
  when: inventory_hostname in groups['swarm_managers']
  changed_when: false
  delegate_to: "{{ groups['swarm_managers'][0] }}"
  run_once: true

- name: Join workers to Swarm
  command: >
    docker swarm join
    --token {{ worker_token.stdout }}
    {{ hostvars[groups['swarm_managers'][0]]['ansible_default_ipv4']['address'] }}:2377
  when:
    - inventory_hostname in groups['swarm_workers']
    - swarm_status.stdout != 'active'
  register: join_result
  failed_when: false
  changed_when: join_result.rc == 0

- name: Wait for workers to join (background process may still be completing)
  pause:
    seconds: 30
  when: inventory_hostname in groups['swarm_workers']

- name: Verify worker joined successfully
  shell: docker info --format '{{"{{"}}.Swarm.LocalNodeState{{"}}"}}'
  register: final_status
  until: final_status.stdout == 'active'
  retries: 6
  delay: 10
  when: inventory_hostname in groups['swarm_workers']
  changed_when: false

- name: Verify Swarm cluster status
  command: docker node ls
  register: node_list
  when: inventory_hostname in groups['swarm_managers']
  changed_when: false
  retries: 3
  delay: 10
  until: node_list.rc == 0

- name: Display Swarm cluster nodes
  debug:
    msg: "{{ node_list.stdout_lines }}"
  when:
    - inventory_hostname in groups['swarm_managers']
    - node_list is defined
