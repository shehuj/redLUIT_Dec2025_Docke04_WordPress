# Ansible Configuration for Docker Swarm Cluster

This directory contains Ansible playbooks and roles to provision and configure a Docker Swarm cluster for WordPress deployment.

## Directory Structure

```
ansible/
├── README.md                  # This file
├── ansible.cfg                # Ansible configuration
├── requirements.yml           # Ansible Galaxy dependencies
├── inventory/                 # Inventory files
│   ├── hosts.ini             # Dynamic inventory (generated by Terraform)
│   └── group_vars/           # Group variables
│       ├── all.yml           # Variables for all hosts
│       ├── swarm_managers.yml # Manager-specific variables
│       └── swarm_workers.yml # Worker-specific variables
├── playbooks/                # Playbooks
│   ├── site.yml              # Main orchestration playbook
│   └── swarm-setup.yml       # Swarm-specific setup
└── roles/                    # Ansible roles
    ├── docker-engine/        # Install Docker
    ├── security-hardening/   # Security configuration
    ├── swarm-init/           # Initialize Swarm
    └── swarm-secrets/        # Create secrets
```

## Prerequisites

### On Control Machine

```bash
# Install Ansible
pip install ansible>=8.0.0

# Install required collections
ansible-galaxy collection install -r requirements.yml

# Or install everything at once
pip install -r ../requirements.txt
ansible-galaxy collection install -r requirements.yml
```

### Required Secrets

Set these environment variables or use Ansible Vault:

```bash
export MYSQL_ROOT_PASSWORD="your_secure_root_password"
export MYSQL_PASSWORD="your_secure_user_password"
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
```

## Quick Start

### 1. Provision Infrastructure

First, use Terraform to provision AWS infrastructure:

```bash
cd ../terraform
./setup-backend.sh
terraform init
terraform apply
```

This generates `inventory/hosts.ini` with your EC2 instance IPs.

### 2. Run Playbook

```bash
# Full cluster setup
ansible-playbook playbooks/site.yml

# Or run specific playbook
ansible-playbook playbooks/swarm-setup.yml

# With verbose output
ansible-playbook playbooks/site.yml -v

# Check mode (dry run)
ansible-playbook playbooks/site.yml --check
```

### 3. Verify Deployment

```bash
# Check Ansible connectivity
ansible all -m ping

# Check Docker installation
ansible swarm -m command -a "docker --version"

# Check Swarm status
ansible swarm_managers -m command -a "docker node ls"

# Check secrets
ansible swarm_managers -m command -a "docker secret ls"
```

## Playbooks

### site.yml (Main Playbook)

Complete cluster setup in order:
1. Install Docker on all nodes
2. Apply security hardening
3. Initialize Docker Swarm
4. Create Docker secrets
5. Verify cluster health

```bash
ansible-playbook playbooks/site.yml
```

### swarm-setup.yml

Swarm-specific configuration only:

```bash
ansible-playbook playbooks/swarm-setup.yml
```

## Roles

### docker-engine

Installs and configures Docker Engine.

**What it does:**
- Installs Docker CE and related packages
- Configures Docker daemon
- Adds users to docker group
- Installs Docker Python library

[See role README](roles/docker-engine/README.md)

### security-hardening

Applies security best practices.

**What it does:**
- Configures UFW firewall
- Opens required Swarm ports
- Installs fail2ban
- Hardens SSH configuration
- Enables automatic security updates

[See role README](roles/security-hardening/README.md)

### swarm-init

Initializes Docker Swarm cluster.

**What it does:**
- Initializes Swarm on manager
- Retrieves join tokens
- Joins managers and workers
- Verifies cluster health

[See role README](roles/swarm-init/README.md)

### swarm-secrets

Creates Docker Swarm secrets.

**What it does:**
- Creates MySQL credentials secrets
- Creates Slack webhook secret
- Verifies secrets exist

[See role README](roles/swarm-secrets/README.md)

## Inventory

### Dynamic Inventory

The `inventory/hosts.ini` file is generated by Terraform and contains:

```ini
[swarm_managers]
swarm-manager-1 ansible_host=<MANAGER_IP> ansible_user=ubuntu

[swarm_workers]
swarm-worker-1 ansible_host=<WORKER1_IP> ansible_user=ubuntu
swarm-worker-2 ansible_host=<WORKER2_IP> ansible_user=ubuntu

[swarm:children]
swarm_managers
swarm_workers
```

### Group Variables

- `group_vars/all.yml` - Variables for all hosts
- `group_vars/swarm_managers.yml` - Manager-specific variables
- `group_vars/swarm_workers.yml` - Worker-specific variables

## Configuration

### ansible.cfg

Key settings:
- Inventory: `inventory/hosts.ini`
- Remote user: `ubuntu`
- Host key checking: Disabled (for automation)
- Privilege escalation: sudo
- Logging: `/tmp/ansible-swarm.log`

### SSH Access

Ansible uses SSH key authentication:

```bash
# Ensure SSH key is available
ssh-add ~/.ssh/your_key.pem

# Or specify in command
ansible-playbook playbooks/site.yml --private-key ~/.ssh/your_key.pem
```

## Common Tasks

### Update Docker

```bash
ansible swarm -m apt -a "name=docker-ce state=latest update_cache=yes" -b
```

### Restart Docker Service

```bash
ansible swarm -m systemd -a "name=docker state=restarted" -b
```

### Check Swarm Status

```bash
ansible swarm_managers -m command -a "docker node ls" -b
```

### View Secrets

```bash
ansible swarm_managers -m command -a "docker secret ls" -b
```

### Run Ad-hoc Commands

```bash
# Check disk space
ansible swarm -m command -a "df -h"

# Check memory
ansible swarm -m command -a "free -h"

# Check Docker info
ansible swarm -m command -a "docker info" -b
```

## Security Best Practices

### 1. Use Ansible Vault for Secrets

```bash
# Create encrypted file
ansible-vault create group_vars/all/vault.yml

# Add secrets
vault_mysql_root_password: your_password
vault_mysql_password: your_password
vault_slack_webhook: your_webhook

# Reference in playbook
mysql_root_password: "{{ vault_mysql_root_password }}"

# Run with vault
ansible-playbook playbooks/site.yml --ask-vault-pass
```

### 2. Use Environment Variables in CI/CD

```yaml
# GitHub Actions
environment:
  MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
  MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### 3. Rotate SSH Keys Regularly

```bash
# Generate new key
ssh-keygen -t ed25519 -f ~/.ssh/swarm_key

# Update in Terraform
# Update in inventory
```

## Troubleshooting

### Connection Issues

```bash
# Test connectivity
ansible all -m ping

# If fails, check:
# 1. SSH key permissions
chmod 600 ~/.ssh/your_key.pem

# 2. Security groups allow SSH
# 3. Correct IP in inventory
```

### Docker Not Starting

```bash
# Check Docker status
ansible swarm -m systemd -a "name=docker status" -b

# View Docker logs
ansible swarm -m command -a "journalctl -u docker -n 50" -b

# Restart Docker
ansible swarm -m systemd -a "name=docker state=restarted" -b
```

### Swarm Join Failures

```bash
# Check Swarm status
ansible swarm_managers -m command -a "docker info | grep Swarm" -b

# Get new join token
ansible swarm_managers -m command -a "docker swarm join-token worker" -b

# Force rejoin
ansible swarm_workers -m command -a "docker swarm leave --force" -b
# Then run playbook again
```

## Testing

### Syntax Check

```bash
ansible-playbook playbooks/site.yml --syntax-check
```

### Dry Run

```bash
ansible-playbook playbooks/site.yml --check
```

### Lint

```bash
# Install ansible-lint
pip install ansible-lint

# Run linter
ansible-lint playbooks/site.yml
ansible-lint roles/
```

## Integration with Terraform

Terraform generates the inventory file:

```hcl
# In terraform/outputs.tf
output "ansible_inventory" {
  value = templatefile("${path.module}/inventory-template.tpl", {
    manager_ip = aws_instance.swarm_manager.public_ip
    worker_ips = aws_instance.swarm_workers[*].public_ip
  })
}
```

Generated inventory is saved to `inventory/hosts.ini`.

## CI/CD Integration

The Ansible playbooks are integrated into GitHub Actions workflows:

- `configure-swarm` job in `main-deployment.yml`
- Runs after infrastructure provisioning
- Uses environment variables for secrets

## Further Documentation

- [Ansible Documentation](https://docs.ansible.com/)
- [Docker Swarm Documentation](https://docs.docker.com/engine/swarm/)
- [Ansible Galaxy Collections](https://galaxy.ansible.com/)

## Support

For issues:
1. Check role README files
2. Review playbook logs
3. Check `/tmp/ansible-swarm.log`
4. Verify inventory and connectivity

## License

MIT

## Author

Created for WordPress on Docker Swarm infrastructure project.
