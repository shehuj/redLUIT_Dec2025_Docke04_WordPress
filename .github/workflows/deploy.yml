name: Swarm Deploy + Monitoring

on:
  # Only deploy on merge to main (not on PRs)
  push:
    branches: [ "main" ]
    paths:
      - 'stack-app/**'
      - 'stack-monitoring/**'
      - '.github/workflows/deploy.yml'
  # Allow manual deployment
  workflow_dispatch:

env:
  SWARM_STACK: levelop-wp
  MON_STACK: monitoring

jobs:

  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push MySQL
        run: |
          docker pull mysql:8.0
          docker tag mysql:8.0 ${{ secrets.DOCKERHUB_USERNAME }}/mysql:8.0-prod
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mysql:8.0-prod

      - name: Push WordPress
        run: |
          docker pull wordpress:latest
          docker tag wordpress:latest ${{ secrets.DOCKERHUB_USERNAME }}/wordpress:latest-prod
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wordpress:latest-prod

  deploy-stacks:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy App + Monitoring
        uses: appleboy/ssh-action@v0.1.7
        env:
          MON_STACK: ${{ env.MON_STACK }}
          SWARM_STACK: ${{ env.SWARM_STACK }}
        with:
          host: ${{ secrets.SWARM_MANAGER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: MON_STACK,SWARM_STACK
          script: |
            # Create secrets if they don't exist
            docker secret ls | grep -q mysql_root_password || \
              echo "${{ secrets.MYSQL_ROOT_PASSWORD }}" | docker secret create mysql_root_password -

            docker secret ls | grep -q mysql_password || \
              echo "${{ secrets.MYSQL_PASSWORD }}" | docker secret create mysql_password -

            docker secret ls | grep -q slack_webhook_url || \
              echo "${{ secrets.SLACK_WEBHOOK_URL }}" | docker secret create slack_webhook_url -

            # Deploy monitoring stack first (creates mon_net network)
            cd stack-monitoring
            docker stack deploy \
              -c monitoring-stack.yml $MON_STACK
            cd ..

            # Deploy application stack (uses mon_net network)
            docker stack deploy --with-registry-auth \
              -c stack-app/docker-stack.yml $SWARM_STACK