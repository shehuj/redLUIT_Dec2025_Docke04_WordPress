name: Swarm Deploy + Monitoring (Standalone)

on:
  # Removed automatic push trigger - use main-deployment.yml instead for merge to main
  # This workflow is now only for manual deployments or testing

  # Allow manual deployment with options
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild and push Docker images'
        required: false
        type: boolean
        default: false
      stack_to_deploy:
        description: 'Which stack to deploy'
        required: false
        type: choice
        default: 'both'
        options:
          - both
          - app
          - monitoring

env:
  SWARM_STACK: levelop-wp
  MON_STACK: monitoring

jobs:

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    if: inputs.stack_to_deploy == 'both' || inputs.stack_to_deploy == 'app' || inputs.force_rebuild

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull and push MySQL image (Idempotent)
        run: |
          echo "üê≥ Processing MySQL image..."
          docker pull mysql:8.0
          docker tag mysql:8.0 ${{ secrets.DOCKERHUB_USERNAME }}/mysql:8.0-prod
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mysql:8.0-prod
          echo "‚úÖ MySQL image ready"

      - name: Pull and push WordPress image (Idempotent)
        run: |
          echo "üê≥ Processing WordPress image..."
          docker pull wordpress:latest
          docker tag wordpress:latest ${{ secrets.DOCKERHUB_USERNAME }}/wordpress:latest-prod
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/wordpress:latest-prod
          echo "‚úÖ WordPress image ready"

  deploy-stacks:
    name: Deploy to Swarm
    needs: build-and-push
    if: always() && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy stacks (Idempotent)
        uses: appleboy/ssh-action@v0.1.7
        env:
          MON_STACK: ${{ env.MON_STACK }}
          SWARM_STACK: ${{ env.SWARM_STACK }}
          STACK_TO_DEPLOY: ${{ inputs.stack_to_deploy || 'both' }}
        with:
          host: ${{ secrets.SWARM_MANAGER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: MON_STACK,SWARM_STACK,STACK_TO_DEPLOY
          script: |
            echo "üöÄ Starting deployment (idempotent)..."

            # Idempotent secret creation - only create if doesn't exist
            docker secret ls | grep -q mysql_root_password || \
              echo "${{ secrets.MYSQL_ROOT_PASSWORD }}" | docker secret create mysql_root_password -

            docker secret ls | grep -q mysql_password || \
              echo "${{ secrets.MYSQL_PASSWORD }}" | docker secret create mysql_password -

            docker secret ls | grep -q slack_webhook_url || \
              echo "${{ secrets.SLACK_WEBHOOK_URL }}" | docker secret create slack_webhook_url -

            # Deploy based on selection
            if [ "$STACK_TO_DEPLOY" = "both" ] || [ "$STACK_TO_DEPLOY" = "monitoring" ]; then
              echo "üìä Deploying monitoring stack..."
              cd stack-monitoring
              docker stack deploy -c monitoring-stack.yml $MON_STACK
              echo "‚úÖ Monitoring stack deployed"
              cd ..
            fi

            if [ "$STACK_TO_DEPLOY" = "both" ] || [ "$STACK_TO_DEPLOY" = "app" ]; then
              echo "üåê Deploying application stack..."
              docker stack deploy --with-registry-auth \
                -c stack-app/docker-stack.yml $SWARM_STACK
              echo "‚úÖ Application stack deployed"
            fi

            # Show deployment status
            sleep 5
            echo ""
            echo "üìä Current stack status:"
            docker stack ls
            echo ""
            if [ "$STACK_TO_DEPLOY" = "both" ] || [ "$STACK_TO_DEPLOY" = "app" ]; then
              docker stack ps $SWARM_STACK --no-trunc | head -20
            fi
            if [ "$STACK_TO_DEPLOY" = "both" ] || [ "$STACK_TO_DEPLOY" = "monitoring" ]; then
              docker stack ps $MON_STACK --no-trunc | head -20
            fi