name: PR to Dev - Provision Infrastructure

on:
  pull_request:
    branches: ["dev"]
    types: [opened, synchronize, reopened]

  workflow_dispatch:
    inputs:
      force_recreate:
        description: 'Force recreate infrastructure'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

env:
  TF_VERSION: '1.6.0'
  ANSIBLE_VERSION: '8.0.0'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PYTHON_VERSION: '3.14'
  ANSIBLE_FORCE_COLOR: 'true'

jobs:
  # Stage 1: Validate infrastructure code
  validate:
    name: Validate Infrastructure Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run validation tests
        run: |
          pytest tests/test_infrastructure.py -v
          pytest tests/test_repo.py -v

      - name: Terraform Format Check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        working-directory: infra/terraform
        run: |
          terraform init -backend=false
          terraform validate

      - name: Ansible Syntax Check
        working-directory: infra/ansible
        run: |
          pip install "ansible>=${{ env.ANSIBLE_VERSION }}"
          ansible-playbook playbooks/site.yml --syntax-check

  # Stage 2: Provision AWS Infrastructure
  provision-infrastructure:
    name: Provision AWS Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || inputs.force_recreate

    outputs:
      manager_ip: ${{ steps.terraform_outputs.outputs.manager_ip }}
      worker_ips: ${{ steps.terraform_outputs.outputs.worker_ips }}
      infrastructure_id: ${{ steps.terraform_outputs.outputs.infrastructure_id }}

    defaults:
      run:
        working-directory: infra/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform Backend
        run: |
          echo "üöÄ Setting up Terraform backend..."
          chmod +x setup-backend.sh
          ./setup-backend.sh || echo "‚ö†Ô∏è Backend may already exist"

      - name: Terraform Init
        run: |
          echo "üîß Initializing Terraform..."
          terraform init -reconfigure

      - name: Check for existing infrastructure
        id: check_infra
        run: |
          if terraform state list | grep -q "aws_instance"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Infrastructure already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üìù No existing infrastructure found"
          fi

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -input=false -out=tfplan -detailed-exitcode || export TF_EXIT=$?
          if [ ${TF_EXIT:-0} -eq 2 ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "üìù Infrastructure changes detected"
          elif [ ${TF_EXIT:-0} -eq 0 ]; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Infrastructure is up to date"
          else
            echo "‚ùå Terraform plan failed"
            exit 1
          fi

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan üìã

            **Infrastructure Changes:** ${{ steps.plan.outputs.changes_detected == 'true' && '‚ö†Ô∏è Changes Detected' || '‚úÖ No Changes' }}

            <details>
            <summary>Show Plan Details</summary>

            \`\`\`
            Run terraform plan to see changes
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Terraform Apply
        if: steps.plan.outputs.changes_detected == 'true' || inputs.force_recreate
        run: |
          echo "üöÄ Applying infrastructure changes..."
          terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform_outputs
        run: |
          echo "manager_ip=$(terraform output -raw swarm_manager_public_ip || echo '')" >> $GITHUB_OUTPUT
          echo "worker_ips=$(terraform output -json swarm_worker_public_ips | jq -r '. | join(",")' || echo '')" >> $GITHUB_OUTPUT
          echo "infrastructure_id=$(date +%s)" >> $GITHUB_OUTPUT

          # Save private key
          terraform output -raw private_key_pem > ../../swarm-key.pem || true
          chmod 600 ../../swarm-key.pem || true

      - name: Generate Ansible Inventory
        if: steps.plan.outputs.changes_detected == 'true' || inputs.force_recreate
        run: |
          terraform output -raw ansible_inventory > ../../infra/ansible/inventory/hosts.ini

      - name: Upload SSH Private Key
        uses: actions/upload-artifact@v4
        with:
          name: ssh-private-key
          path: swarm-key.pem
          retention-days: 7

      - name: Upload Ansible Inventory
        uses: actions/upload-artifact@v4
        with:
          name: ansible-inventory
          path: infra/ansible/inventory/hosts.ini
          retention-days: 7

  # Stage 3: Configure Swarm Cluster
  configure-swarm:
    name: Configure Docker Swarm Cluster
    needs: provision-infrastructure
    runs-on: ubuntu-latest
    if: needs.provision-infrastructure.outputs.manager_ip != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Ansible Inventory
        uses: actions/download-artifact@v4
        with:
          name: ansible-inventory
          path: infra/ansible/inventory/

      - name: Download SSH Private Key
        uses: actions/download-artifact@v4
        with:
          name: ssh-private-key
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install "ansible>=${{ env.ANSIBLE_VERSION }}"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          mv swarm-key.pem ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add all hosts to known_hosts
          MANAGER_IP="${{ needs.provision-infrastructure.outputs.manager_ip }}"
          WORKER_IPS="${{ needs.provision-infrastructure.outputs.worker_ips }}"

          if [ -n "$MANAGER_IP" ]; then
            ssh-keyscan -H "$MANAGER_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi

          if [ -n "$WORKER_IPS" ]; then
            IFS=',' read -ra IPS <<< "$WORKER_IPS"
            for ip in "${IPS[@]}"; do
              ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts 2>/dev/null || true
            done
          fi

          # Verify key format
          echo "Verifying SSH key format..."
          if ssh-keygen -l -f ~/.ssh/id_rsa; then
            echo "‚úÖ SSH key format is valid"
          else
            echo "‚ùå SSH key format is invalid"
            exit 1
          fi

      - name: Wait for instances to be ready
        run: |
          echo "‚è≥ Waiting for instances to fully boot..."
          sleep 180

      - name: Test SSH connectivity
        env:
          MANAGER_IP: ${{ needs.provision-infrastructure.outputs.manager_ip }}
        run: |
          echo "Testing SSH to manager..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${MANAGER_IP} 'echo "‚úÖ SSH connection successful"' || {
            echo "‚ùå SSH connection failed, retrying in 30s..."
            sleep 30
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${MANAGER_IP} 'echo "‚úÖ SSH connection successful"'
          }

      - name: Run Ansible playbook (Idempotent)
        working-directory: infra/ansible
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          echo "üîß Configuring Swarm cluster..."
          ansible-playbook -i inventory/hosts.ini playbooks/site.yml -v || {
            echo "‚ùå Ansible playbook failed, retrying once..."
            sleep 30
            ansible-playbook -i inventory/hosts.ini playbooks/site.yml -v
          }

      - name: Verify Swarm cluster
        env:
          MANAGER_IP: ${{ needs.provision-infrastructure.outputs.manager_ip }}
        run: |
          echo "üîç Verifying Swarm cluster..."
          ssh -o StrictHostKeyChecking=no ubuntu@${MANAGER_IP} 'docker node ls'
          ssh -o StrictHostKeyChecking=no ubuntu@${MANAGER_IP} 'docker secret ls'

      - name: Comment PR with Success
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### ‚úÖ Infrastructure Provisioned Successfully

            **Manager IP:** \`${{ needs.provision-infrastructure.outputs.manager_ip }}\`
            **Worker IPs:** \`${{ needs.provision-infrastructure.outputs.worker_ips }}\`

            **Swarm Cluster:** Ready for stack deployment

            **Next Steps:**
            1. Merge this PR to \`main\` to deploy application stacks
            2. Or manually test by SSHing to manager

            **SSH Access:**
            \`\`\`bash
            # Download the SSH key from artifacts
            ssh -i swarm-key.pem ubuntu@${{ needs.provision-infrastructure.outputs.manager_ip }}
            \`\`\`

            ‚ö†Ô∏è **Note:** This infrastructure will remain active until PR is closed or manually destroyed.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Comment PR with Failure
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### ‚ùå Infrastructure Provisioning Failed

            **Error:** Swarm cluster configuration failed

            **Troubleshooting:**
            1. Check the workflow logs for detailed errors
            2. Verify security groups allow Swarm ports (2377, 7946, 4789)
            3. Ensure UFW rules allow VPC traffic
            4. Check that all instances are reachable

            **Manual Fix:**
            You can run \`./fix-ufw.sh\` to fix common firewall issues.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Final Summary
  deployment-summary:
    name: Deployment Summary
    needs: [validate, provision-infrastructure, configure-swarm]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Infrastructure Provisioning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation:** ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Infrastructure:** ${{ needs.provision-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Swarm Setup:** ${{ needs.configure-swarm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.configure-swarm.result }}" = "success" ]; then
            echo "## ‚úÖ Infrastructure Ready" >> $GITHUB_STEP_SUMMARY
            echo "Manager IP: \`${{ needs.provision-infrastructure.outputs.manager_ip }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Merge to main to deploy application stacks!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Provisioning Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
